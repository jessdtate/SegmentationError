import os
import threading
#import numpy as np


def implicit_model(vol_fname, point_fname, outputfile_path, out_name):

    layers = importlayer(filename=vol_fname, importer='[Teem Importer]', mode='data')
    wait_for_layer(layers[0])

    pnts = load_points(point_fname)

#    tool = opentool(tooltype = 'implicitmodeltool')
#    set(stateid = tool+"::seed_points", value = pnts)
#    pnts_ = get(stateid = tool+"::seed_points")

    pnt_str_l = [ '['+str(p[0]) + ','+str(p[1]) + ',' + str(p[2]) + ']' for p in pnts ]
    pnt_str = '[' + ','.join(pnt_str_l)+']'

    command = "im_model = implicitmodel(layerid=layers[0], vertices=" + pnt_str + ",  view_modes='[[coronal]]', normal_offset= 2)"
#    exec(command)
    im_model = implicitmodel(layerid=layers[0],vertices=pnts, view_modes='[[coronal]]', normal_offset='2',convex_hull_2D='false',invert_seed_order='false',kernel='thin_plate')
  
#    implicitmodel(layerid='layer_0',vertices='[[-17.4015,15,41.4717],[-22.6839,15,-13.1235],[35.4226,15,-32.496],[61.8347,15,0.378543],[47.1613,15,24.4474]]',view_modes='[[coronal],[coronal],[coronal],[coronal],[coronal]]',normal_offset='2',convex_hull_2D='false',invert_seed_order='false',kernel='thin_plate')
  
#    implicitmodel(layerid='layer_0',vertices=[[-31.0487,-4.20975,-32.0863],[16.1315,-9.55522,-40.3893],[-46.5695,-23.3927,-16.5319],[-30.1696,11.2075,-30.2825],[3.62445,-22.3768,-38.5409],[30.0292,-29.6416,-40.7586],[-34.2162,-26.5468,20.8768],[-15.4794,31.8742,33.2607],[-38.0409,-28.3396,5.51522],[53.7664,2.50005,-35.6904],[-55.7533,-16.5881,2.57682],[13.301,31.731,-36.6115],[0.644374,-34.0547,-33.9163],[63.8895,-2.32955,-20.885],[12.0051,-34.8336,14.548],[64.3628,25.4751,4.41762],[-23.1752,-21.067,-33.0082],[3.21664,9.44827,-35.9509],[-51.652,-17.0186,-18.9637],[-0.426243,41.3473,-31.7725],[9.92153,-35.3685,-36.1885],[60.0498,-13.8726,1.66642],[-9.53541,-28.2466,32.6042],[28.9332,26.8188,47.9504],[2.08803,-38.502,-0.69952],[56.0422,29.9588,-25.1426],[-35.8481,13.6925,4.20759],[31.5217,41.7466,-34.8564],[52.5147,-30.0007,-13.8127],[54.9421,8.12393,25.8531],[4.16952,-28.7823,30.7297],[51.3958,53.2441,9.12647],[-19.5863,-34.7129,-22.6514],[19.5121,-24.1753,-41.5572],[-59.7897,-8.65728,1.96677],[-35.5634,18.3064,-13.6376],[-43.0949,9.16836,-24.542],[51.2605,-9.83514,-38.4758],[-16.788,-20.9804,45.4272],[-5.56519,38.7911,36.7526],[-25.8582,-32.6049,3.12018],[34.6249,27.8062,-37.2786],[-55.1885,-10.0477,23.0242],[28.0026,53.2556,-29.435],[5.18706,-40.7363,-19.3339],[65.8107,18.6044,-11.6284],[33.1483,-7.57732,37.9586],[55.9441,39.0721,19.9274],[-10.4272,-37.7338,-7.51063],[6.24724,3.10894,-37.3146],[-59.2447,-8.17744,-7.7284],[4.12887,48.4516,-29.1974],[28.8074,-40.2646,-25.0228],[45.0963,-16.7524,21.3874],[2.49839,-17.7894,47.296],[13.3557,50.2094,40.9053],[0.398304,-36.4657,7.89399],[61.2746,27.7831,-18.901],[-40.6778,8.07916,42.0405],[21.938,63.2965,-19.1263],[35.6029,-36.7773,-4.45911],[29.3723,4.03823,46.18],[15.6359,-8.76613,48.6282],[20.9706,68.1992,4.7155],[-44.8042,-20.5966,-26.5472],[27.7726,-9.72512,-42.2569],[-47.521,-23.4604,-7.89427],[-21.915,25.9188,-27.4084],[-3.43158,-5.35716,-36.3003],[44.3309,-35.0526,-29.0803],[-42.5122,-13.0006,39.1394],[-21.9019,29.4485,18.929],[-43.4824,-23.7385,14.6349],[36.1547,4.91871,-40.6232],[-49.3165,-5.31782,37.6349],[44.1919,35.9411,-32.6603],[-0.034541,-38.8742,-26.5603],[66.4349,2.53519,-5.68961],[28.1314,-30.61,14.911],[59.5092,22.7981,20.3338],[-18.4556,-28.6991,-31.6168],[-1.91805,27.3224,-34.06],[-47.3624,8.70635,-14.7663],[-21.6057,29.4281,3.56717],[20.531,-37.4924,-36.4472],[52.5777,-14.7261,15.0794],[-24.2137,-21.3428,42.1309],[7.44891,22.373,52.6477],[17.9326,-38.9038,-0.373275],[44.7714,56.2396,-15.1376],[-32.5427,18.6868,22.3283],[11.3068,60.1978,-21.1635],[47.272,-29.9876,0.434356],[44.4601,27.97,39.0043],[19.0189,-19.3388,37.1371],[30.4717,64.4813,20.7565],[-32.974,-25.75,-29.1568],[40.2058,-20.14,-42.165],[-59.1994,-7.33028,11.0431],[-20.5939,32.6152,-17.0318],[-13.428,-21.5841,-34.0725],[60.348,-18.2781,-21.2598],[-31.839,-17.5512,42.888],[18.6413,41.6627,48.889],[-25.5743,-28.1383,25.215],[60.658,14.4767,-25.4695],[-42.553,8.09181,33.5612],[41.7673,62.3094,-4.94725],[23.6225,-41.0092,-17.1327],[65.701,8.0426,1.99439],[26.5265,-13.0453,37.7429],[38.6444,44.6511,38.8733],[-23.6971,-34.297,-15.7514],[18.2994,13.6187,-38.9354],[-31.0605,20.3364,-1.50657],[-14.0043,42.0227,-0.74297],[51.7756,-30.7527,-23.2124],[47.0931,3.734,33.0281],[-14.1481,12.5094,56.874],[-6.64112,45.9126,10.26],[5.71553,-32.3818,22.7505],[60.7439,40.2077,-0.119846],[-22.9142,21.647,44.2363],[-6.57313,48.9917,0.552533],[43.2148,-29.3248,6.87272],[27.2839,12.9175,47.6977],[17.1062,2.3326,51.3073],[2.37736,57.4362,2.96999],[-50.3183,1.87991,-20.5491],[20.6195,3.06322,-40.2175],[-55.8002,-16.3306,-10.2892],[-19.0252,8.6335,-32.3809],[6.04942,-7.47835,-37.7455],[43.4923,-30.2216,-36.7097],[-38.7966,-20.8398,29.7012],[-8.67989,34.0923,40.986],[-29.5675,-30.8428,8.95641],[49.3994,10.0636,-37.0002],[-54.2475,-14.5114,17.5001],[16.9534,42.4041,-35.118],[-5.59929,-20.1007,-36.088],[63.8427,7.02077,-22.0369],[21.251,-29.4014,23.1179],[61.9409,27.0859,12.9427],[-34.4946,-14.3777,-31.8173],[-8.01721,23.1157,-32.9916],[-57.0789,-9.09485,-16.1572],[0.711662,53.5109,-22.5229],[6.90806,-28.2454,-38.8509],[60.5878,-0.424968,12.6271],[-10.3402,-24.9355,39.4372],[25.2088,38.0657,48.0376],[8.64786,-37.3452,6.85316],[44.3216,48.7516,-24.4255],[-39.6965,11.2025,26.1566],[20.748,52.8329,-30.9585],[58.0126,-20.699,-4.91557],[52.3305,18.0169,31.1792],[2.61212,-24.8407,38.0877],[51.1003,48.1827,20.4193],[-38.564,-26.6584,-24.8549],[29.9776,-20.4372,-42.5712],[-50.9645,1.84267,4.3674],[-24.0387,29.1784,-7.55148],[-30.8355,21.0492,-25.1491],[60.1364,-5.54763,-29.3365],[-12.2243,-11.7269,52.979],[5.42372,47.3223,36.6193],[-21.2035,-32.0914,14.4765],[50.9913,23.2807,-33.234],[-52.0886,-1.95264,26.9651],[37.5367,59.2278,-18.3669],[13.8294,-41.0193,-11.4303],[65.0064,25.2123,-3.93554],[39.6148,2.79531,38.971],[43.9738,44.6419,33.4329],[-14.8615,-35.7708,-0.739687],[11.9435,19.6715,-37.1109],[-49.4716,4.84148,-5.51367],[11.7446,54.4181,-28.4865],[38.2491,-38.6882,-23.4039],[46.057,-6.24227,28.6906],[-4.67431,-18.1138,48.7176],[14.4012,60.7865,29.7789],[-13.0351,-33.5925,14.6413],[55.478,45.354,-14.053],[-35.1798,11.5072,52.247],[30.3807,65.9911,-8.87569],[35.2573,-34.5794,3.14696],[34.2132,19.8672,46.2218],[-0.354401,4.76281,57.7602],[16.1646,66.9548,11.8421],[-44.1184,-5.71704,-28.7064],[27.8526,13.9853,-39.6069],[-47.9125,-22.6859,4.51164],[-18.3454,32.8281,-26.4261],[-8.98002,9.4352,-33.6054],[56.8494,-21.3061,-29.6578],[-35.3357,-3.67758,51.1338],[-14.8949,36.7948,16.5467],[-47.602,-18.3304,22.8997],[42.2729,11.8678,-39.0814],[-44.0909,-5.9739,44.5092],[41.0122,42.0547,-30.8325],[-1.92971,-39.5116,-10.5444],[64.9979,-4.1423,-4.06076],[33.8547,-19.75,26.9806],[52.8899,35.2672,27.7225],[-12.7034,-37.2622,-16.9728],[-5.17958,33.843,-32.044],[-42.4477,10.9466,-5.7016],[-18.8294,34.1085,8.86691],[15.8208,-39.9656,-30.8493],[55.0243,-3.78056,19.8055],[-18.9416,-8.14563,54.5843],[2.43808,38.1659,48.5124],[26.5586,-34.4754,7.69295],[53.6386,51.0987,-6.04768],[-27.6307,20.9019,34.4055],[11.2651,65.0612,-0.170728],[50.1095,-23.7184,7.80302],[39.9748,35.408,41.4875],[12.0555,-23.7295,35.4906],[40.3844,53.4297,30.1871],[-39.9385,-27.952,-6.58265],[38.0826,-4.77296,-41.6072],[-47.2319,4.62891,17.1471],[-12.459,44.1581,-16.0085],[-14.9956,-4.05607,-34.3805],[62.427,-14.3605,-13.382],[-30.147,4.69341,57.054],[29.1007,49.9569,42.5374],[-26.0121,-24.079,34.9783],[63.5527,19.8574,-18.5729],[-35.4762,14.1809,38.0586],[36.3077,64.8981,9.44567],[27.9866,-39.3307,-8.95496],[61.1872,12.6686,16.4064],[24.3283,-8.04112,43.5337],[23.5678,59.553,34.0249],[-31.0936,-31.8621,-8.77905],[25.5783,28.9688,-37.5734],[-30.4248,19.9915,15.6324],[-4.70095,53.4931,-9.93805],[46.0034,-34.553,-12.4176],[42.2186,16.6282,40.6361],[-6.71803,15.2132,56.204],[-4.9482,41.3825,24.5999],[-9.43485,-31.5785,23.4025],[59.8293,39.4086,8.19012],[-17.7977,25.9268,43.3637],[0.403002,52.189,11.4237],[37.9014,-21.8914,21.6542],[10.3753,32.0783,49.6842],[12.3212,11.4329,54.2625],[6.64236,55.2037,23.3151],[-25.565,3.22702,-32.1377],[22.129,-4.71161,-41.2719],[-38.9346,-28.8563,-15.3454],[-23.7558,15.9976,-30.4757],[3.62593,-14.4439,-38.0851],[37.1721,-27.5255,-40.9578],[-31.489,-24.6584,29.3669],[-11.6917,36.8191,27.727],[-36.9656,-27.4883,12.0597],[56.8293,9.21454,-32.2019],[-55.8214,-15.4683,9.95345],[22.0571,35.1478,-36.6346],[-4.42869,-27.4736,-35.1775],[65.7557,1.7441,-14.0358],[19.801,-33.5727,14.5579],[62.9899,32.5919,3.37885],[-25.7907,-15.008,-33.2313],[2.21103,16.4772,-34.8895],[-51.5283,-9.21187,-24.112],[7.76201,41.2526,-34.3103],[16.3043,-30.4696,-40.2649],[61.6165,-6.79856,5.41695],[-2.69726,-28.9856,31.1684],[33.6329,33.8217,46.4405],[10.2051,-39.2834,-2.02803],[55.8769,37.5427,-20.8449],[-31.044,19.1095,8.47164],[35.1462,48.6923,-29.8001],[58.7982,-21.8472,-12.3301],[58.0066,15.4563,23.5094],[14.0233,-27.2733,29.9005],[45.2927,59.4975,8.54507],[-8.58695,-37.0245,-24.8599],[23.0393,-16.4139,-42.0258],[-56.1669,-3.33403,-0.870575],[-29.8558,24.4205,-11.9695],[-37.6474,14.4867,-25.3321],[55.4566,-4.2875,-34.9299],[-12.2694,-18.4015,48.5914],[0.690784,42.989,36.2314],[-18.8428,-33.9564,6.9846],[41.9893,27.338,-36.3083],[-55.0554,-3.0517,18.1193],[38.992,53.7652,-23.8655],[13.4788,-41.4711,-19.9637],[66.3604,17.4258,-3.01498],[41.2882,-4.21013,34.1569],[55.2207,45.0484,15.0577],[-4.82173,-37.6798,-0.986037],[12.4027,9.80527,-37.9633],[-54.4752,1.97557,-10.2775],[12.8556,47.8902,-32.8229],[36.0743,-36.7692,-33.1414],[49.939,-10.4527,21.5945],[9.28615,-13.5288,48.1603],[18.2565,53.9853,39.6447],[3.18701,-34.7616,15.6579],[60.5431,35.8782,-14.6332],[-38.8148,5.33025,50.0892],[29.2442,63.2304,-16.1279],[42.7301,-34.0428,-3.96112],[34.0115,10.6451,45.0127],[11.2897,-2.40518,52.9835],[30.3393,67.6852,5.50177],[-41.5415,-13.1488,-30.1597],[31.1797,-1.94489,-41.5896],[-43.4706,-25.6505,0.192565],[-14.0647,26.5676,-30.7764],[-2.62648,1.53833,-35.2579],[51.2831,-27.8493,-32.9285],[-36.2292,-11.2675,46.5636],[-19.0255,32.1454,24.115],[-40.8222,-22.8141,22.4231],[45.4853,2.77775,-39.3786],[-48.0114,0.479956,34.4188],[49.6528,39.5152,-26.2715],[7.89704,-40.0387,-27.5747],[67.0591,10.2721,-7.36513],[29.0279,-26.4202,21.8505],[57.5113,30.419,22.3083],[-12.0453,-33.1308,-30.1695],[4.55753,33.8602,-34.76],[-40.6939,14.0974,-15.9079],[-19.1185,33.4435,-2.07466],[28.2455,-37.599,-33.7236],[57.5057,-8.50457,12.6275],[-22.0386,-15.3597,49.8693],[13.0582,37.8043,49.5762],[26.9114,-37.5506,-1.05954],[48.1663,57.111,-5.66498],[-24.8487,25.4483,21.5751],[16.7474,65.5109,-12.9776],[54.2053,-22.9954,1.24909],[49.6409,29.9424,33.3655],[27.2878,-18.5289,32.181],[36.197,61.4654,23.7943],[-27.0808,-31.0363,-26.6193],[43.7036,-13.8266,-41.5144],[-53.7708,-1.17129,11.4457],[-15.3102,38.812,-19.8372],[-13.8805,-12.6337,-34.7209],[62.3061,-10.4783,-22.2768],[-28.7465,-12.3582,49.804],[23.7665,46.7597,45.9614],[-18.1736,-28.4569,29.6367],[58.0241,21.527,-26.3765],[-33.9306,17.3153,30.5669],[41.4022,63.0818,1.86299],[33.3646,-39.892,-16.9006],[65.1785,15.5209,4.87039],[33.8214,-1.01022,41.308],[35.5469,52.5311,35.9894],[-18.339,-35.9796,-10.3794],[26.1162,22.0414,-38.9774],[-26.4767,24.7872,0.259261],[-11.8054,44.9981,-6.56664],[56.4503,-25.4672,-20.8039],[49.9187,10.1306,32.4188],[-6.39905,24.4935,51.7774],[0.852765,49.8444,17.6296],[13.3626,-31.4876,22.9764],[56.4191,47.791,-0.323964],[-20.0936,21.074,52.0242],[-0.383026,55.9678,-3.91598],[46.4842,-22.3017,14.05],[23.7504,18.4485,49.6446],[18.745,9.42621,50.9757],[7.72945,61.1576,7.84334],[-43.838,1.66136,-27.6099],[27.3403,6.55762,-40.2471],[-52.8924,-19.1409,-3.26348],[-14.8514,16.1476,-31.4828],[12.6019,-1.35529,-38.9112],[50.6822,-20.8582,-37.6763],[-35.2461,-19.2119,36.9439],[3.62468,31.2338,48.3021],[-28.0439,-29.5045,17.2037],[53.3703,16.6733,-33.3848],[-50.1529,-11.4453,29.9919],[25.0491,44.7454,-34.172],[-4.58299,-11.8717,-36.5659],[65.4891,10.8326,-16.2581],[23.1127,-24.3435,29.2716],[59.9017,34.3831,13.809],[-22.9083,-7.35763,-33.7104],[4.10987,24.7268,-35.0935],[-55.3997,-2.64896,-17.2854],[3.66339,59.141,-17.2362],[12.1872,-17.2063,-40.1264],[62.7108,7.5768,11.3457],[-3.77744,-23.2323,42.2304],[32.8996,42.1906,44.1209],[17.3497,-37.0378,6.66612],[49.8788,51.9857,-14.5874],[-39.133,11.6878,19.0559],[30.8121,58.2527,-23.6515],[62.5093,-12.2423,-4.95248],[54.5471,24.736,28.4427],[8.7047,-20.2595,41.8546],[47.8702,54.8523,15.8179],[-31.1335,-31.8391,-17.7111],[35.073,-13.2317,-42.6087],[-44.4154,6.47952,10.471],[-18.1548,36.2952,-10.0552],[-28.2546,25.6909,-19.295],[61.0297,3.17476,-28.0554],[-3.40793,-10.6642,53.3772],[8.95301,54.5614,30.6433],[-17.3743,-30.9513,22.2477],[49.7938,30.5103,-31.5513],[-46.9667,3.1904,25.3258],[38.8395,62.3022,-11.0371],[20.1889,-40.263,-9.0637],[62.7943,34.5731,-5.84155],[42.1172,9.62652,39.6156],[46.6698,49.8702,26.2313],[-9.70484,-35.7085,5.79536],[16.5782,24.7826,-37.3189],[-44.2152,7.4162,1.90786],[19.6065,59.0984,-24.9103],[46.0756,-35.4442,-20.8592],[51.3186,-0.716596,26.4304],[3.68203,-8.91045,52.7764],[23.9887,63.6014,27.0998],[-5.70445,-34.644,13.1996],[59.2103,42.5847,-8.44915],[-28.9833,17.1152,51.3539],[32.431,66.8343,-1.93276],[38.53,-25.9949,15.6697],[37.806,24.9801,44.2228],[5.64765,2.61433,55.3746],[28.156,66.6179,15.21],[-35.6042,2.32116,-30.3571],[35.0649,16.4979,-39.5993],[-49.1116,-20.8701,12.37],[-11.4218,37.7463,-27.8714],[-5.68915,15.4335,-33.9483],[58.2587,-13.6229,-31.1843],[-26.6653,-3.7711,55.0343],[-8.08955,41.4992,16.8748],[-44.6052,-15.8819,31.7378],[43.1353,19.4966,-37.6111],[-42.4425,0.0934018,46.8897],[50.4735,46.1037,-21.2848],[5.4531,-40.5411,-10.9143],[64.2103,0.478174,4.15152],[35.3922,-12.5959,32.188],[50.1688,41.9958,27.8569],[-4.86262,-39.1289,-18.0174],[-6.75329,44.2915,-26.4778],[-36.093,15.6564,-4.68082],[-14.1181,40.17,7.10953],[20.4482,-41.4731,-24.9381],[57.9408,4.06433,19.7585],[-8.18265,-3.87479,57.0629],[8.59166,45.265,44.935],[35.7316,-30.7101,10.0771],[49.5026,56.1822,1.42028],[-24.1086,25.2101,31.5679],[21.9061,67.6125,-6.7538],[55.8965,-16.4665,7.78486],[45.317,36.9425,35.8854],[17.1428,-14.8886,42.8304],[42.9727,57.0234,22.0194],[-33.3984,-30.8758,-1.75155],[45.2938,-4.64899,-40.5595],[-37.6824,12.2045,11.8589],[-6.23451,49.7977,-19.0209],[-13.0489,1.67837,-34.0691],[64.5635,-7.03467,-13.1039],[-15.6477,2.85093,58.8361],[26.9674,56.8981,40.0868],[-18.1259,-25.484,36.616],[63.8969,27.7284,-11.1898],[-32.3129,15.9806,44.0377],[40.4308,61.9796,14.6978],[38.9242,-37.8881,-13.016],[63.1881,19.198,11.5805],[24.7529,-2.25147,46.7103], [32.6193,59.3571,30.7381],[-23.1013,-34.186,-3.73338], [34.4576,35.631,-35.7252],[-25.0827,25.2253,10.5532], [7.69721,63.6482,-10.4827],[52.3418,-28.517,-6.63843], [46.8825,19.9722,36.917], [5.34182,16.0322,55.2796], [-0.143626,46.3068,24.8842],[-2.91094,-32.5867,22.3758], [56.0914,47.3077,7.28407],[-12.5785,28.0664,45.9177], [8.87964,59.8308,18.1649],[41.2743,-13.4265,27.5368], [21.3081,28.7241,49.5173], [15.2363,20.2834,50.384], [17.1164,65.1651,22.1961]], view_modes='[[coronal]]',normal_offset='2',convex_hull_2D='false',invert_seed_order='false',kernel='thin_plate')
    
#    "implicitmodel(layerid='layer_0',vertices=[[-31.0487,-4.20975,-32.0863],[16.1315,-9.55522,-40.3893],[-46.5695,-23.3927,-16.5319],[-30.1696,11.2075,-30.2825],[3.62445,-22.3768,-38.5409],[30.0292,-29.6416,-40.7586],[-34.2162,-26.5468,20.8768],[-15.4794,31.8742,33.2607],[-38.0409,-28.3396,5.51522],[53.7664,2.50005,-35.6904]], view_modes='[[coronal]]',normal_offset='2',convex_hull_2D='false',invert_seed_order='false',kernel='thin_plate')"
  
  
    print(im_model)
    wait_for_layer(im_model)
    set(stateid=im_model+'::name',value=out_name+'_vol')
    result=exportlayer(layer=im_model, file_path = os.path.join(outputpath,out_name+'_vol'), exporter='[NRRD Exporter]', extension='.nrrd')
    
    upper_threshold = get(stateid = im_model+'::max')
    lower_threshold = 0

    seg_im = threshold(layerid=im_model, lower_threshold='0', upper_threshold=upper_threshold)
    wait_for_layer(seg_im)
    seg_vol = calculatemaskvolume(mask = seg_im)

    if get(stateid = seg_im+'::calculated_volume') == 0:
      print("WARNING: No segmentation")
      
    computeisosurface(layerid=seg_im)
    exportisosurface(layer=seg_im, file_path=outputpath+name+'.fac', binary='false')
    
    return im_model
  
def load_points(filename):

    fid = open(filename, "r")
    str_dump = fid.read()
    fid.close()

    lines = str_dump.split('\n')

    pnts = [ [float(p) for p in l.split('   ')] for l in lines[:-1]]

#    pnts=np.loadtxt(filename)

#    return pnts.tolist()
    return pnts


def wait_for_layer(layer,MAX_ITERATIONS = 1000):
  
  #checks to make sure that the layer is available before trying operations on it.
  TIMEOUT=1
  c = threading.Condition()
  c.acquire()
  
  layerStatus = get(stateid=layer+"::data")
  counter = 1
  success = 1
  with c:
    while not layerStatus == "available":
      if counter > MAX_ITERATIONS:
        print('waited too long for '+layer)
        success = 0
        break
      counter += 1
      c.wait(TIMEOUT)
      layerStatus = get(stateid=layer+"::data")
  #print('waiting for '+layer)

  return success
